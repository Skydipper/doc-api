# GeoDoctor

## What is the GeoDoctor service?

GeoDoctor is a service to receive geospatial datafiles of various kinds, extract shapes, repair and simplify those shapes.
The service responds with a valid geojson object that can be consumed by other Skydipper services such as Geostore.

File conversion is done with GDAL OGR2OGR), and
optional cleaning and simplification is done using the [visvalingam method](https://github.com/mbloch/mapshaper/wiki/Command-Reference),
preserving features with Mapshaper.

### An example with GEOSJON

Given an input file which contains:

```json
{'type': 'FeatureCollection',
 'features': [{'type': 'Feature',
   'properties': {},
   'geometry': {'type': 'Polygon',
    'coordinates': [[[-8.690185546875, 32.8334428466495],
      [-9.140625, 32.648625783736726],
      [-9.052734375, 32.44488496716713],
      [-8.865966796875, 32.27784451498272],
      [-8.8330078125, 32.16631295696736],
      [-8.865966796875, 32.008075959291055],
      [-8.98681640625, 31.970803930433096],
      [-9.33837890625, 31.93351676190369],
      [-9.64599609375, 31.672083485607402],
      [-9.755859375, 31.23159167205059],
      [-9.481201171875, 31.005862904624205],
      [-9.041748046875, 30.552800413453546],
      [-9.0966796875, 30.173624550358536],
      [-9.239501953125, 30.002516938570686],
      [-8.3056640625, 29.707139348134145],
      [-7.965087890625, 29.964452850852005],
      [-7.921142578125, 30.259067203213018],
      [-8.052978515625, 30.4297295750316],
      [-8.3056640625, 30.524413269923986],
      [-8.4375, 30.609549797190844],
      [-8.3056640625, 30.798474179567823],
      [-8.140869140625, 30.713503990354965],
      [-8.074951171875, 30.675715404167743],
      [-7.987060546875, 30.62845887475364],
      [-7.91015625, 30.5717205651999],
      [-7.822265625000001, 30.543338954230222],
      [-7.701416015625001, 30.543338954230222],
      [-7.679443359375, 30.6662659463233],
      [-7.811279296874999, 30.80791068136646],
      [-7.965087890625, 30.883369321692268],
      [-8.052978515625, 30.92107637538488],
      [-8.19580078125, 30.95876857077987],
      [-8.28369140625, 30.987027960280326],
      [-8.382568359375, 31.071755902820133],
      [-8.349609375, 31.22219703210317],
      [-8.06396484375, 31.287939892641734],
      [-7.833251953125, 31.297327991404266],
      [-6.723632812499999, 32.26855544621476],
      [-7.822265625000001, 32.537551746769],
      [-8.10791015625, 31.970803930433096],
      [-8.646240234375, 31.96148355726853],
      [-8.37158203125, 32.194208672875384],
      [-8.118896484375, 32.676372772089834],
      [-8.690185546875, 32.8334428466495]]]}}]}
```

From this file you can call the GeoDoctor service like this:

```python
import requests
url = "http://api.skydipper.com/v1/geodoctor/convert"
querystring = {"simplify":"10", "clean":"true"}
files = {'file': open('<path_to_your_file>/<your_file.geosjon>', 'rb'), 'Accept': "application/json, text/pain, */*"}
r = requests.post(url, files=files, params=querystring)
print(r.json())
```

Which will result in a response like:

```json
{'data': {'type': 'geoJSON',
  'id': 'undefined',
  'attributes': {'type': 'FeatureCollection',
   'features': [{'type': 'Feature',
     'properties': {'__id': 0},
     'geometry': {'type': 'Polygon',
      'coordinates': [[[-8.690185546875, 32.8334428466495],
        [-6.723632812499999, 32.26855544621476],
        [-7.833251953125, 31.297327991404266],
        [-8.3056640625, 29.707139348134145],
        [-9.755859375, 31.23159167205059],
        [-8.690185546875, 32.8334428466495]]]}}]}}}
```

Note the simplification of `simplify: 10` means that the shape has been simplified by 90%.

### Example with Well-Known-text

You can upload Well-Known-Text format also, e.g. given a sample file with the contents:

```csv
index, geom,
1,"POLYGON ((-3.6694335937500004 40.896905775860006, -3.14208984375 40.58058466412761, -2.8125 40.81380923056958, -2.96630859375 41.16211393939692, -3.6035156249999996 41.44272637767212, -4.306640625 41.52502957323801, -5.053710937499999 41.47566020027821, -5.47119140625 41.32732632036622, -5.80078125 41.0130657870063, -5.91064453125 40.54720023441049, -5.888671875 40.06125658140474, -5.64697265625 39.690280594818034, -5.185546875 39.41922073655956, -4.32861328125 39.30029918615029, -3.427734375 39.30029918615029, -3.01025390625 39.554883059924016, -3.01025390625 39.87601941962116, -2.548828125 39.90973623453719, -2.57080078125 40.195659093364654, -3.97705078125 40.212440718286466, -3.97705078125 39.9434364619742, -3.5595703125 39.926588421909436, -3.5815429687499996 39.757879992021756, -4.50439453125 39.690280594818034, -5.053710937499999 39.8928799002948, -5.20751953125 40.07807142745009, -5.295410156249999 40.39676430557203, -5.3173828125 40.84706035607122, -4.89990234375 41.02964338716638, -4.4384765625 41.062786068733026, -3.80126953125 41.062786068733026, -3.6694335937500004 40.896905775860006))"
```

You can use that file as an input to the service like so:

```python
import requests
url = "http://api.skydipper.com/v1/geodoctor/convert"
querystring = {"simplify":"90", "clean":"true"}
files = {'file': open('<path_to_your_file>/<your_file.csv>', 'rb'), 'Accept': "application/json, text/pain, */*"}
r = requests.post(url, files=files, params=querystring)
```

Gives a response of:

```json
{'geojson': {'type': 'FeatureCollection',
  'features': [{'type': 'Feature',
    'properties': {'index': '1', 'field_3': None, '__id': 0},
    'geometry': {'type': 'Polygon',
     'coordinates': [[[-3.66943359375, 40.896905775860006],
       [-3.80126953125, 41.062786068733026],
       [-4.89990234375, 41.02964338716638],
       [-5.3173828125, 40.84706035607122],
       [-5.20751953125, 40.07807142745009],
       [-5.053710937499999, 39.8928799002948],
       [-4.50439453125, 39.690280594818034],
       [-3.58154296875, 39.757879992021756],
       [-3.5595703125, 39.926588421909436],
       [-3.97705078125, 39.9434364619742],
       [-3.97705078125, 40.212440718286466],
       [-2.57080078125, 40.195659093364654],
       [-2.548828125, 39.90973623453719],
       [-3.01025390625, 39.87601941962116],
       [-3.01025390625, 39.554883059924016],
       [-3.427734375, 39.30029918615029],
       [-4.32861328125, 39.30029918615029],
       [-5.185546875, 39.41922073655956],
       [-5.64697265625, 39.690280594818034],
       [-5.888671875, 40.06125658140474],
       [-5.91064453125, 40.54720023441049],
       [-5.80078125, 41.0130657870063],
       [-5.47119140625, 41.32732632036622],
       [-5.053710937499999, 41.47566020027821],
       [-4.306640625, 41.52502957323801],
       [-3.603515625, 41.44272637767212],
       [-2.96630859375, 41.16211393939692],
       [-2.8125, 40.81380923056958],
       [-3.14208984375, 40.58058466412761],
       [-3.66943359375, 40.896905775860006]]]}}],
  'crs': {'type': 'name',
   'properties': {'name': 'urn:ogc:def:crs:OGC:1.3:CRS84'}}}}
```